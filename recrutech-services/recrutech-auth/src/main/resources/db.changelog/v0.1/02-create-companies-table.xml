<?xml version="1.0" encoding="UTF-8"?>
<!--
# Company Management Module - Companies Table
# Version: 1.0.0
# Author: Efehan Cekic [efehan.cekic@student.htw-berlin.de]
# Description: Creates the companies table for managing company information and verification
# Dependencies: users table (for admin_user_id foreign key)
-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- Create companies table for company management -->
    <changeSet id="create-companies-table-v1.0" author="efehan.cekic@student.htw-berlin.de">
        <comment>
            Creates the companies table for managing company information:
            - Basic company information (name, location, contact details)
            - Business email and telephone (unique constraints)
            - Admin user relationship (foreign key to users table)
            - Company verification system
            - Contact person information
        </comment>
        
        <createTable tableName="companies">
            <!-- Primary Key and Base Entity Fields -->
            <column name="id" type="char(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_at" type="datetime">
                <constraints nullable="false"/>
            </column>
            
            <!-- Core Company Information -->
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="location" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="business_email" type="varchar(254)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="telephone" type="varchar(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <!-- Contact Person Information -->
            <column name="contact_first_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="contact_last_name" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Admin User Relationship -->
            <column name="admin_user_id" type="char(36)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Company Verification System -->
            <column name="verified" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="verification_token" type="varchar(255)"/>
            <column name="verification_expiry" type="datetime"/>
        </createTable>
    </changeSet>

    <!-- Create performance indexes for companies table -->
    <changeSet id="create-companies-indexes-v1.0" author="efehan.cekic@student.htw-berlin.de">
        <comment>
            Creates essential indexes for the companies table to optimize query performance:
            - Business email index for company lookup
            - Admin user ID index for user-company relationships
            - Company name index for search operations
            - Verification token index for verification process
        </comment>
        
        <createIndex tableName="companies" indexName="idx_companies_business_email">
            <column name="business_email"/>
        </createIndex>
        
        <createIndex tableName="companies" indexName="idx_companies_admin_user_id">
            <column name="admin_user_id"/>
        </createIndex>
        
        <createIndex tableName="companies" indexName="idx_companies_name">
            <column name="name"/>
        </createIndex>
        
        <createIndex tableName="companies" indexName="idx_companies_verification_token">
            <column name="verification_token"/>
        </createIndex>
        
        <createIndex tableName="companies" indexName="idx_companies_verified">
            <column name="verified"/>
        </createIndex>
    </changeSet>

    <!-- Add foreign key constraints for companies table -->
    <changeSet id="create-companies-foreign-keys-v1.0" author="efehan.cekic@student.htw-berlin.de">
        <comment>
            Creates foreign key constraints for the companies table:
            - Links admin_user_id to users.id to ensure referential integrity
            - Ensures that every company has a valid admin user
        </comment>
        
        <addForeignKeyConstraint 
            baseTableName="companies" 
            baseColumnNames="admin_user_id"
            constraintName="fk_companies_admin_user"
            referencedTableName="users" 
            referencedColumnNames="id"
            onDelete="RESTRICT"
            onUpdate="CASCADE"/>
    </changeSet>

</databaseChangeLog>